= Kube 인증서 관리
:toc:
:toc-title:

== kube-system 인증서 유효기간 확인

kube-system 인증서의 유효기간은 기본적으로 1년이다. kube-system 인증서의 유효기간 확인을 통해 인증서의 갱신 여부를 판단한다.
----
$ kubeadm alpha certs check-expiration
----

== kube-system 인증서 갱신

kube-system 인증서는 1년마다 갱신을 해야한다. 이때 모든 마스터 노드에서 순차적으로 진행한다.

. *인증서 갱신*
+
----
$ kubeadm alpha certs renew all
----

. *kube-system 파드 재기동*
+
갱신한 인증서를 적용하기 위해 kube-system 파드를 재기동한다. 이때 마스터 노드 별로 진행하는 것을 권장한다.
+
----
$ kubectl get pods -n kube-system -o wide | grep [노드 이름]
$ kubectl delete pods -n kube-system etcd-[노드 이름] kube-apiserver-[노드 이름] kube-controller-manager-[노드 이름] kube-proxy-xxxxx kube-scheduler-[노드 이름]
----

. *config 교체*
+
kube-system 파드 재기동 완료 후 kubelet 사용을 위해 새로 갱신한 config로 교체한다.
+
----
$ cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
----

. *인증서 갱신 확인*
+
갱신된 인증서는 아래 명령어를 통해 확인할 수 있다.
+
----
# etcd 
$ openssl s_client -host [node-ip] -port 2379 | openssl x509 -text | grep Not

# api-server 
$ openssl s_client -host [node-ip] -port 2379 | openssl x509 -text | grep Not

# scheduler 
$ openssl s_client -host 127.0.0.1 -port 10259 | openssl x509 -text | grep Not

# controller 
$ openssl s_client -host 127.0.0.1 -port 10257 | openssl x509 -text | grep Not
----

== 사용자 생성 인증서 유효기간 확인

기본적으로 생성되는 ServiceAccount의 Secret은 /etc/kubernetes/pki/ca.crt 인증서를 사용하고, 유효기간은 10년이다. 이외에 TLS 타입의 Secret은 사용자가 생성한 인증서를 사용하기에 유효기간을 확인할 필요가 있다.

----
$ kubectl get secret -A | grep "kubernetes.io/tls"
----

== 공인 인증서 적용
