= Gitlab 백업 및 복구
:toc:
:toc-title:

본 장에서는 Gitlab 애플리케이션 데이터 백업에 대해 설명한다. 단, 백업을 생성한 Gitlab 버전 및 유형과 동일한 버전으로만 복구할 수 있다.

== 백업 

. *백업 파일 생성* +
백업 파일을 생성한다.
+
.실행 방법
----
kubectl exec -it -n [네임스페이스 이름] [파드 이름] gitlab-rake gitlab:backup:create
----
+
.예시
----
# kubectl exec -it -n gitlab-system gitlab-5c59765867-rnp8v gitlab-rake gitlab:backup:create
----

. *백업 파일 복사* +
컨테이너에 생성된 파일을 노드로 복사한다. 이때 백업 파일의 이름은 `* _gitlab_backup.tar` 형태로 작성한다. 
+
.실행 방법
----
kubectl cp [네임스페이스 이름]/[파드 이름]:var/opt/gitlab/backups/[백업 대상 파일 이름] [복사할 위치]/[백업 파일 이름]
----
+
.예시
----
# kubectl cp gitlab-system/gitlab-5c59765867-rnp8v:var/opt/gitlab/backups/1652685285_2022_05_16_13.6.4_gitlab_backup.tar ./test__gitlab_backup.tar
----

. *시크릿 및 설정값 복사* +
컨테이너 안에 있는 시크릿 및 설정값을 복사한다.
+
.실행 방법
----
kubectl exec -it -n [네임스페이스 이름] [파드 이름] -- tar cf - "etc/gitlab" | tar xf -
----
+
.예시
----
# kubectl exec -n "gitlab-system" "gitlab-5c59765867-rnp8v" -- tar cf - "etc/gitlab" | tar xf -
----

. *Omnibus 설정값 복사* +
컨테이너 안에 있는 Omnibus 설정값을 복사한다.
+
.실행 방법
----
kubectl exec -it -n [네임스페이스 이름] [파드 이름] -- tar cf - "tmp/shared" | tar xf -
----
+
.예시
----
# kubectl exec -n "gitlab-system" "gitlab-5c59765867-rnp8v" -- tar cf - "tmp/shared" | tar xf -
----

== 복구

. *Omnibus 설정값 파드에 저장* +
복구할 Gitlab 컨테이너 안에 백업해둔 Omnibus 설정값을 저장한다.
+
.실행 방법
----
kubectl cp tmp [네임스페이스 이름]/[파드 이름]:tmp
----
+
.예시
----
# kubectl cp tmp/shared gitlab-system/gitlab-5c59765867-rnp8v:tmp
----

. *시크릿 및 설정값을 파드에 저장* +
복구할 Gitlab 컨테이너 안에 백업해둔 시크릿 및 설정값을 저장한다.
+
.실행 방법
----
kubectl cp etc/gitlab [네임스페이스 이름]/[파드 이름]:etc
----
+
.예시
----
# kubectl cp etc/gitlab gitlab-system/gitlab-5c59765867-rnp8v:etc
----


. *백업 파일 파드에 저장* +
복구할 Gitlab 컨테이너 안에 백업해둔 파일을 저장한다.
+
.실행 방법
----
kubectl cp [백업 파일 이름] [네임스페이스 이름]/[파드 이름]:var/opt/gitlab/backups
----
+
.예시
----
# kubectl cp test.tar gitlab-system/gitlab-5c59765867-rnp8v:var/opt/gitlab/backups
----

. *Omnibus 값 설정* +
백업했던 Gitlab과 같은 환경을 만들기 위해 Omnibus 값을 설정한다.
+
----
kubectl exec -it -n [네임스페이스 이름] [파드 이름] bash
- export GITLAB_OMNIBUS_CONFIG="$(cat /tmp/shared/omnibus.env)"
- echo 'export GITLAB_OMNIBUS_CONFIG="$(cat /tmp/shared/omnibus.env)"' >> /root/.bashrc
- /assets/wrapper
----

. *복구 수행* +
백업 파일을 이용해 복구한다.
+
.실행 방법
----
kubectl exec -it -n [네임스페이스 이름] [파드 이름] gitlab-backup restore BACKUP=[백업 파일 이름]
----